@page "/aprovar-pedidos"
@using InovaSaude.Blazor.Models
@using InovaSaude.Blazor.Services
@inject PedidoMedicamentoService PedidoService
@inject EstoqueFarmaciaService EstoqueService
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "ADMIN,FARMACEUTICO")]

<PageTitle>Aprovar Pedidos - Farmácia Central</PageTitle>

<LoadingOverlay IsLoading="carregando" Message="Carregando pedidos..." />

<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
<h2>? Aprovar Pedidos de Medicamentos</h2>
  <div>
    <span class="badge bg-warning fs-6">@pedidosPendentes.Count pendentes</span>
        </div>
    </div>

    @if (string.IsNullOrEmpty(mensagem) == false)
    {
   <div class="alert @(mensagemSucesso ? "alert-success" : "alert-danger") alert-dismissible">
  @mensagem
            <button type="button" class="btn-close" @onclick="() => mensagem = null"></button>
  </div>
    }

    <SkeletonLoader IsLoading="carregando" Type="SkeletonLoader.SkeletonType.Table" Rows="5" Columns="6">
   @if (pedidosPendentes.Any())
        {
      <div class="table-responsive">
         <table class="table table-hover">
   <thead class="table-light">
      <tr>
     <th>Número</th>
<th>UBS Solicitante</th>
    <th>Data Pedido</th>
           <th>Prioridade</th>
   <th>Itens</th>
<th>Ações</th>
    </tr>
 </thead>
<tbody>
    @foreach (var pedido in pedidosPendentes)
   {
         <tr>
       <td><strong>@pedido.NumeroPedido</strong></td>
      <td>@pedido.UbsSolicitante?.Nome</td>
           <td>@pedido.DataPedido.ToString("dd/MM/yyyy HH:mm")</td>
   <td>
    <span class="badge @GetPrioridadeClass(pedido.Prioridade)">
      @pedido.Prioridade
         </span>
   </td>
  <td>@pedido.Itens.Count itens</td>
  <td>
       <button class="btn btn-sm btn-primary" @onclick="() => AbrirDetalhesPedido(pedido)">
   <span class="oi oi-eye me-1"></span>Analisar
   </button>
       </td>
    </tr>
  }
        </tbody>
     </table>
   </div>
        }
else
     {
  <div class="empty-state">
          <div class="empty-state-icon">??</div>
    <h4>Nenhum pedido pendente</h4>
  <p class="text-muted">Todos os pedidos foram processados!</p>
            </div>
 }
    </SkeletonLoader>
</div>

<!-- Modal Detalhes do Pedido -->
<ConfirmModal IsVisible="mostrarModal"
      Title="@($"Pedido {pedidoSelecionado?.NumeroPedido}")"
      Type="ConfirmModal.ModalType.Info"
    Size="ConfirmModal.ModalSize.Large"
         ShowCancelButton="true"
         ShowCloseButton="true"
    CancelText="Fechar"
       ConfirmText="Salvar Aprovação"
              IsProcessing="processando"
      OnConfirm="ProcessarAprovacao"
          OnCancel="FecharModal">
    
  @if (pedidoSelecionado != null)
  {
     <div class="row mb-3">
 <div class="col-md-6">
         <p><strong>UBS Solicitante:</strong> @pedidoSelecionado.UbsSolicitante?.Nome</p>
     <p><strong>Data do Pedido:</strong> @pedidoSelecionado.DataPedido.ToString("dd/MM/yyyy HH:mm")</p>
</div>
  <div class="col-md-6">
    <p><strong>Prioridade:</strong> 
<span class="badge @GetPrioridadeClass(pedidoSelecionado.Prioridade)">
@pedidoSelecionado.Prioridade
    </span>
   </p>
  <p><strong>Observações:</strong> @(pedidoSelecionado.Observacoes ?? "Nenhuma")</p>
 </div>
   </div>

 <h5 class="mt-4 mb-3">Itens Solicitados</h5>
<div class="table-responsive">
<table class="table table-sm">
 <thead>
    <tr>
          <th>Medicamento</th>
      <th>Solicitado</th>
         <th>Disponível</th>
<th>Aprovar</th>
      <th>Status</th>
      </tr>
  </thead>
      <tbody>
      @foreach (var item in pedidoSelecionado.Itens)
         {
  var disponivel = estoquesDisponiveis.FirstOrDefault(e => 
           e.NomeMedicamento == item.NomeMedicamento);
   
    <tr>
<td>
    <strong>@item.NomeMedicamento</strong><br/>
       <small class="text-muted">
         @item.PrincipioAtivo - @item.Concentracao - @item.FormaFarmaceutica
       </small>
          </td>
 <td><strong>@item.QuantidadeSolicitada</strong></td>
     <td>
    @if (disponivel != null)
      {
       <span class="@(disponivel.QuantidadeAtual >= item.QuantidadeSolicitada ? "text-success" : "text-danger")">
           @disponivel.QuantidadeAtual
       </span>
       }
     else
     {
 <span class="text-danger">0</span>
       }
       </td>
   <td>
  <input type="number" 
  class="form-control form-control-sm" 
      style="width: 100px;"
       min="0" 
      max="@(disponivel?.QuantidadeAtual ?? 0)"
         @bind="item.QuantidadeAprovada" />
      </td>
 <td>
        @if ((item.QuantidadeAprovada ?? 0) == item.QuantidadeSolicitada)
   {
      <span class="badge bg-success">Aprovado Total</span>
         }
       else if ((item.QuantidadeAprovada ?? 0) > 0)
         {
       <span class="badge bg-warning">Aprovado Parcial</span>
  }
      else
     {
       <span class="badge bg-danger">Não Aprovado</span>
       }
      </td>
     </tr>
 }
  </tbody>
   </table>
     </div>

  <div class="mt-4">
   <div class="form-check form-check-inline">
  <input class="form-check-input" type="radio" name="decisao" id="aprovar" value="aprovar" @onchange="() => decisaoFinal = 'aprovar'" checked="@(decisaoFinal == "aprovar")">
       <label class="form-check-label" for="aprovar">
    ? Aprovar Pedido
      </label>
        </div>
  <div class="form-check form-check-inline">
 <input class="form-check-input" type="radio" name="decisao" id="rejeitar" value="rejeitar" @onchange="() => decisaoFinal = "rejeitar"">
      <label class="form-check-label" for="rejeitar">
 ? Rejeitar Pedido
   </label>
    </div>
</div>

  @if (decisaoFinal == "rejeitar")
 {
 <div class="mt-3">
   <label class="form-label">Motivo da Rejeição *</label>
     <textarea class="form-control" rows="3" @bind="motivoRejeicao" placeholder="Informe o motivo da rejeição..."></textarea>
      </div>
        }
    }

</ConfirmModal>

<style>
    .empty-state {
 padding: 4rem 2rem;
        text-align: center;
    }

    .empty-state-icon {
 font-size: 5rem;
        opacity: 0.3;
  margin-bottom: 1rem;
    }
</style>

@code {
    private List<PedidoMedicamento> pedidosPendentes = new();
    private List<EstoqueFarmacia> estoquesDisponiveis = new();
    private PedidoMedicamento? pedidoSelecionado;
    private bool carregando = true;
    private bool mostrarModal;
    private bool processando;
    private string? mensagem;
  private bool mensagemSucesso;
    private string decisaoFinal = "aprovar";
    private string? motivoRejeicao;

    protected override async Task OnInitializedAsync()
{
        await CarregarPedidosPendentes();
  }

  private async Task CarregarPedidosPendentes()
    {
  carregando = true;
try
   {
pedidosPendentes = await PedidoService.GetPedidosByStatusAsync("PENDENTE");
        }
  catch (Exception ex)
  {
         ToastService.ShowError($"Erro ao carregar pedidos: {ex.Message}");
   }
     finally
        {
     carregando = false;
        }
    }

    private async Task AbrirDetalhesPedido(PedidoMedicamento pedido)
    {
     pedidoSelecionado = pedido;
  decisaoFinal = "aprovar";
        motivoRejeicao = null;

        // Carregar estoque disponível
     try
{
 estoquesDisponiveis = await EstoqueService.GetAllAsync();
     
      // Pre-preencher quantidades aprovadas com o solicitado
   foreach (var item in pedidoSelecionado.Itens)
      {
      var disponivel = estoquesDisponiveis.FirstOrDefault(e => e.NomeMedicamento == item.NomeMedicamento);
        item.QuantidadeAprovada = disponivel != null && disponivel.QuantidadeAtual >= item.QuantidadeSolicitada
       ? item.QuantidadeSolicitada
  : disponivel?.QuantidadeAtual ?? 0;
}
}
    catch (Exception ex)
        {
   ToastService.ShowError($"Erro ao carregar estoque: {ex.Message}");
 }

        mostrarModal = true;
    }

 private void FecharModal()
  {
     mostrarModal = false;
     pedidoSelecionado = null;
        estoquesDisponiveis.Clear();
    }

    private async Task ProcessarAprovacao()
    {
 if (pedidoSelecionado == null) return;

  if (decisaoFinal == "rejeitar" && string.IsNullOrWhiteSpace(motivoRejeicao))
     {
      ToastService.ShowWarning("Informe o motivo da rejeição");
            return;
        }

        processando = true;
   try
   {
     if (decisaoFinal == "aprovar")
       {
     await PedidoService.AprovarPedidoAsync(pedidoSelecionado.Id);
   ToastService.ShowSuccess($"Pedido {pedidoSelecionado.NumeroPedido} aprovado com sucesso!");
   }
   else
    {
     await PedidoService.RejeitarPedidoAsync(pedidoSelecionado.Id, motivoRejeicao!);
   ToastService.ShowSuccess($"Pedido {pedidoSelecionado.NumeroPedido} rejeitado.");
            }

         await CarregarPedidosPendentes();
      FecharModal();
        }
        catch (Exception ex)
        {
      ToastService.ShowError($"Erro ao processar pedido: {ex.Message}");
   }
        finally
   {
processando = false;
  }
 }

    private string GetPrioridadeClass(string prioridade) => prioridade switch
    {
   "URGENTE" => "bg-danger",
 "ALTA" => "bg-warning",
   "NORMAL" => "bg-info",
     "BAIXA" => "bg-secondary",
     _ => "bg-primary"
    };
}
