@page "/login"
@using InovaSaude.Blazor.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop
@inject UsuarioService UsuarioService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS

<PageTitle>Login - InovaSa√∫de</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
   <div class="col-md-6 col-lg-4">
    <div class="card shadow-lg">
    <div class="card-body p-5">
           <div class="text-center mb-4">
         <h2 class="fw-bold">üè• InovaSa√∫de</h2>
       <p class="text-muted">Sistema de Gest√£o de UBS</p>
   </div>
  
       <EditForm Model="loginModel" OnValidSubmit="HandleLogin">
  <DataAnnotationsValidator />

   <div class="mb-3">
        <label class="form-label fw-semibold">Email</label>
       <InputText class="form-control form-control-lg" @bind-Value="loginModel.Email" placeholder="seu@email.com" />
     <ValidationMessage For="@(() => loginModel.Email)" class="text-danger small" />
     </div>

  <div class="mb-3">
      <label class="form-label fw-semibold">Senha</label>
  <InputText type="password" class="form-control form-control-lg" @bind-Value="loginModel.Password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
   <ValidationMessage For="@(() => loginModel.Password)" class="text-danger small" />
      </div>

        @if (!string.IsNullOrEmpty(error))
   {
   <div class="alert alert-danger d-flex align-items-center" role="alert">
     <span class="oi oi-warning me-2"></span>
  <span>@error</span>
  </div>
  }

   <button class="btn btn-primary btn-lg w-100 mb-3" type="submit" disabled="@isLoading">
      @if (isLoading)
        {
<span class="spinner-border spinner-border-sm me-2"></span>
     <span>Entrando...</span>
  }
  else
 {
<span class="oi oi-account-login me-2"></span>
        <span>Entrar</span>
   }
 </button>
      </EditForm>

<div class="mt-4 p-3 bg-light rounded">
     <p class="text-center small text-muted mb-2"><strong>Credenciais de Teste:</strong></p>
  <p class="small mb-1"><strong>Admin:</strong> admin@inovasaude.com.br | Admin@123</p>
  <p class="small mb-1"><strong>Coordenador:</strong> coordenador@inovasaude.com.br | Coord@123</p>
  <p class="small mb-1"><strong>Gestor:</strong> gestor@inovasaude.com.br | Gestor@123</p>
     <p class="small mb-0"><strong>Operador:</strong> operador@inovasaude.com.br | Oper@123</p>
    </div>
    </div>
  </div>
        </div>
    </div>
</div>

@code {
    private LoginModel loginModel = new();
    private string? error;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
     {
    Navigation.NavigateTo("/dashboard");
        }
    }

    private async Task HandleLogin()
    {
 error = null;
 isLoading = true;

    try
        {
     if (string.IsNullOrWhiteSpace(loginModel.Email) || string.IsNullOrWhiteSpace(loginModel.Password))
       {
  error = "Por favor, preencha todos os campos.";
           return;
 }

     var user = await UsuarioService.GetUsuarioByEmailAsync(loginModel.Email);
   
      if (user == null)
       {
   error = "Email ou senha inv√°lidos.";
                return;
      }

      var verified = BCrypt.Net.BCrypt.Verify(loginModel.Password, user.SenhaHash);
    
 if (!verified)
            {
      error = "Email ou senha inv√°lidos.";
       return;
            }

          if (user.Status != "ATIVO")
       {
      error = "Usu√°rio inativo. Entre em contato com o administrador.";
    return;
    }

      // Redirecionar para o endpoint GET do controller que far√° o login
            var loginUrl = $"/account/login?email={Uri.EscapeDataString(loginModel.Email)}&password={Uri.EscapeDataString(loginModel.Password)}";
      await JS.InvokeVoidAsync("eval", $"window.location.href = '{loginUrl}'");
        }
      catch (Exception ex)
    {
 error = $"Erro: {ex.Message}";
     }
   finally
    {
    isLoading = false;
        }
    }

    public class LoginModel
    {
   [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Email √© obrigat√≥rio")]
        [System.ComponentModel.DataAnnotations.EmailAddress(ErrorMessage = "Email inv√°lido")]
        public string Email { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Senha √© obrigat√≥ria")]
[System.ComponentModel.DataAnnotations.MinLength(6, ErrorMessage = "Senha deve ter no m√≠nimo 6 caracteres")]
     public string Password { get; set; } = string.Empty;
 }
}
