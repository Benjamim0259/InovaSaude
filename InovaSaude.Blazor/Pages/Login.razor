@page "/login"
@using InovaSaude.Blazor.Services
@inject UsuarioService UsuarioService
@inject NavigationManager Navigation
@inject Microsoft.AspNetCore.Authentication.IAuthenticationService AuthService
@inject IHttpContextAccessor HttpContextAccessor

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
            <div class="card shadow">
                <div class="card-body p-4">
                    <h3 class="text-center mb-4">üè• Login - InovaSa√∫de</h3>
                    
                    <EditForm Model="loginModel" OnValidSubmit="HandleLogin">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="alert alert-danger" />

                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <InputText class="form-control" @bind-Value="loginModel.Email" placeholder="admin@inovasaude.com.br" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Senha</label>
                            <InputText type="password" class="form-control" @bind-Value="loginModel.Password" placeholder="Admin@123" />
                        </div>

                        @if (!string.IsNullOrEmpty(error))
                        {
                            <div class="alert alert-danger">@error</div>
                        }

                        <button class="btn btn-primary w-100" type="submit" disabled="@isLoading">
                            @if (isLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            Entrar
                        </button>
                        
                        <div class="mt-3 text-center text-muted">
                            <small>Credenciais padr√£o:<br/>admin@inovasaude.com.br / Admin@123</small>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private LoginModel loginModel = new();
    private string? error;
    private bool isLoading = false;

    private async Task HandleLogin()
    {
        error = null;
        isLoading = true;
        
        try
        {
            var user = await UsuarioService.GetUsuarioByEmailAsync(loginModel.Email);
            
            if (user == null)
            {
                error = "Credenciais inv√°lidas";
                return;
            }

            var verified = BCrypt.Net.BCrypt.Verify(loginModel.Password, user.SenhaHash);
            
            if (!verified)
            {
                error = "Credenciais inv√°lidas";
                return;
            }

            // Login bem-sucedido - redirecionar com reload para atualizar autentica√ß√£o
            Navigation.NavigateTo($"/account/login?email={Uri.EscapeDataString(loginModel.Email)}&password={Uri.EscapeDataString(loginModel.Password)}", true);
        }
        catch (Exception ex)
        {
            error = "Erro ao fazer login. Tente novamente.";
        }
        finally
        {
            isLoading = false;
        }
    }

    public class LoginModel
    {
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }
}
