@page "/relatorios-financeiros"
@using InovaSaude.Blazor.Services
@using InovaSaude.Blazor.Models
@using System.Globalization
@inject DespesaService DespesaService
@inject FuncionarioService FuncionarioService
@inject ESFService ESFService
@inject CategoriaService CategoriaService
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<PageTitle>Relat√≥rios Financeiros - InovaSa√∫de</PageTitle>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üìä Relat√≥rios Financeiros</h2>
        <div class="btn-group">
            <button class="btn btn-outline-success" @onclick="ExportarExcel" disabled="@carregando">
                <span class="oi oi-data-transfer-download me-2"></span>Excel
            </button>
            <button class="btn btn-outline-danger" @onclick="ExportarPDF" disabled="@carregando">
                <span class="oi oi-document me-2"></span>PDF
            </button>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">üîç Filtros</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Per√≠odo</label>
                    <select class="form-select" @bind="periodoSelecionado" @bind:after="CarregarDados">
                        <option value="mes">M√™s Atual</option>
                        <option value="trimestre">√öltimo Trimestre</option>
                        <option value="semestre">√öltimo Semestre</option>
                        <option value="ano">Ano Atual</option>
                        <option value="personalizado">Personalizado</option>
                    </select>
                </div>
                @if (periodoSelecionado == "personalizado")
                {
                    <div class="col-md-3">
                        <label class="form-label">Data In√≠cio</label>
                        <input type="date" class="form-control" @bind="dataInicio" @bind:after="CarregarDados" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data Fim</label>
                        <input type="date" class="form-control" @bind="dataFim" @bind:after="CarregarDados" />
                    </div>
                }
                <div class="col-md-3">
                    <label class="form-label">UBS</label>
                    <select class="form-select" @bind="EsfIdFiltro" @bind:after="CarregarDados">
                        <option value="">Todas</option>
                        @foreach (var ubs in esfList)
                        {
                            <option value="@ubs.Id">@ubs.Nome</option>
                        }
                    </select>
                </div>
            </div>
        </div>
    </div>

    @if (carregando)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
            <p class="mt-3">Carregando relat√≥rios...</p>
        </div>
    }
    else
    {
        <!-- DASHBOARD EXECUTIVO -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">üí∞ Total Despesas</h6>
                        <h3 class="text-primary mb-0">@totalDespesas.ToString("C", new CultureInfo("pt-BR"))</h3>
                        <small class="text-muted">@quantidadeDespesas despesas</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">üìä M√©dia por Despesa</h6>
                        <h3 class="text-success mb-0">@((quantidadeDespesas > 0 ? totalDespesas / quantidadeDespesas : 0).ToString("C", new CultureInfo("pt-BR")))</h3>
                        <small class="text-muted">Valor m√©dio</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">üë• Total Sal√°rios</h6>
                        <h3 class="text-info mb-0">@totalSalarios.ToString("C", new CultureInfo("pt-BR"))</h3>
                        <small class="text-muted">@quantidadeFuncionarios funcion√°rios</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr√°fico de Barras por Categoria -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">üìä Despesas por Categoria</h5>
            </div>
            <div class="card-body">
                @if (despesasPorCategoria.Any())
                {
                    <div class="row">
                        <div class="col-md-8">
                            @foreach (var item in despesasPorCategoria.OrderByDescending(x => x.Total))
                            {
                                var percentual = totalDespesas > 0 ? (item.Total / totalDespesas * 100) : 0;
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span><strong>@item.CategoriaNome</strong></span>
                                        <span>@item.Total.ToString("C", new CultureInfo("pt-BR")) (@percentual.ToString("F1")%)</span>
                                    </div>
                                    <div class="progress" style="height: 30px;">
                                        <div class="progress-bar @GetCategoriaColor(item.CategoriaNome)" 
                                             role="progressbar" 
                                             style="width: @percentual%"
                                             aria-valuenow="@percentual" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            @item.Quantidade despesas
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        <div class="col-md-4">
                            <h6 class="mb-3">Top 3 Categorias</h6>
                            @foreach (var item in despesasPorCategoria.OrderByDescending(x => x.Total).Take(3))
                            {
                                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                                    <span>@item.CategoriaNome</span>
                                    <span class="badge @GetCategoriaColor(item.CategoriaNome)">
                                        @item.Total.ToString("C", new CultureInfo("pt-BR"))
                                    </span>
                                </div>
                            }
                        </div>
                    </div>
                }
                else
                {
                    <p class="text-muted">Nenhuma despesa no per√≠odo selecionado.</p>
                }
            </div>
        </div>

        <!-- Ranking de UBS por Gastos -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">üè• Ranking UBS - Despesas</h5>
                    </div>
                    <div class="card-body p-0">
                        @if (despesasPorUBS.Any())
                        {
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-hover mb-0">
                                    <thead class="sticky-top bg-white">
                                        <tr>
                                            <th>#</th>
                                            <th>UBS</th>
                                            <th class="text-end">Total</th>
                                            <th class="text-end">Qtd</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @{ int posicao = 1; }
                                        @foreach (var item in despesasPorUBS.OrderByDescending(x => x.Total))
                                        {
                                            <tr>
                                                <td>
                                                    @if (posicao == 1) { <span class="badge bg-warning">ü•á</span> }
                                                    else if (posicao == 2) { <span class="badge bg-secondary">ü•à</span> }
                                                    else if (posicao == 3) { <span class="badge bg-danger">ü•â</span> }
                                                    else { <span>@posicao</span> }
                                                </td>
                                                <td>@item.UbsNome</td>
                                                <td class="text-end"><strong>@item.Total.ToString("C", new CultureInfo("pt-BR"))</strong></td>
                                                <td class="text-end">@item.Quantidade</td>
                                            </tr>
                                            posicao++;
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted p-3">Nenhuma despesa no per√≠odo.</p>
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üë• Ranking UBS - Sal√°rios</h5>
                    </div>
                    <div class="card-body p-0">
                        @if (salariosPorUBS.Any())
                        {
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-hover mb-0">
                                    <thead class="sticky-top bg-white">
                                        <tr>
                                            <th>#</th>
                                            <th>UBS</th>
                                            <th class="text-end">Total Sal√°rios</th>
                                            <th class="text-end">Funcion√°rios</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @{ int pos = 1; }
                                        @foreach (var item in salariosPorUBS.OrderByDescending(x => x.TotalSalarios))
                                        {
                                            <tr>
                                                <td>@pos</td>
                                                <td>@item.UbsNome</td>
                                                <td class="text-end"><strong>@item.TotalSalarios.ToString("C", new CultureInfo("pt-BR"))</strong></td>
                                                <td class="text-end">@item.QuantidadeFuncionarios</td>
                                            </tr>
                                            pos++;
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted p-3">Nenhum funcion√°rio cadastrado.</p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr√°fico de Linha por Categoria -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üìà Evolu√ß√£o Mensal por Categoria</h5>
                    <select class="form-select w-auto" @bind="categoriaFiltroGrafico" @bind:after="AtualizarGraficoLinha">
                        <option value="">Todas as Categorias</option>
                        <option value="SALARIOS">üí∞ Sal√°rios</option>
                        @foreach (var cat in categorias)
                        {
                            <option value="@cat.Id">@cat.Nome</option>
                        }
                    </select>
                </div>
            </div>
            <div class="card-body">
                @if (evolucaoMensalPorCategoria.Any())
                {
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <svg width="100%" height="300" style="overflow: visible;">
                            <!-- Eixo Y -->
                            <line x1="50" y1="20" x2="50" y2="280" stroke="#ccc" stroke-width="2"/>
                            <!-- Eixo X -->
                            <line x1="50" y1="280" x2="95%" y2="280" stroke="#ccc" stroke-width="2"/>

                            @{
                                var maxValorGrafico = evolucaoMensalPorCategoria.Any() ? evolucaoMensalPorCategoria.Max(e => e.Total) : 1;
                                var totalPontos = evolucaoMensalPorCategoria.Count;
                                var larguraTotal = 90; // porcentagem
                                var espacoEntrePontos = totalPontos > 1 ? larguraTotal / (totalPontos - 1) : 0;

                                var pontos = new List<string>();
                                for (int i = 0; i < evolucaoMensalPorCategoria.Count; i++)
                                {
                                    var item = evolucaoMensalPorCategoria[i];
                                    var x = 50 + (espacoEntrePontos * i * 10); // ajuste de escala
                                    var y = 280 - ((item.Total / maxValorGrafico) * 240);
                                    pontos.Add($"{x},{y}");
                                }
                                var pathPoints = string.Join(" ", pontos);
                            }

                            <!-- Linha do gr√°fico -->
                            @if (pontos.Count > 1)
                            {
                                <polyline points="@pathPoints" 
                                         fill="none" 
                                         stroke="#0d6efd" 
                                         stroke-width="3"/>
                            }

                            <!-- Pontos e labels -->
                            @for (int i = 0; i < evolucaoMensalPorCategoria.Count; i++)
                            {
                                var item = evolucaoMensalPorCategoria[i];
                                var x = 50 + (espacoEntrePontos * i * 10);
                                var y = 280 - ((item.Total / maxValorGrafico) * 240);

                                <circle cx="@x" cy="@y" r="5" fill="#0d6efd"/>
                                <g>
                                    <text x="@x" y="295" text-anchor="middle" font-size="10" fill="#666">@item.MesNome</text>
                                    <text x="@x" y="@(y - 10)" text-anchor="middle" font-size="10" fill="#0d6efd" font-weight="bold">@item.Total.ToString("C0", new CultureInfo("pt-BR"))</text>
                                </g>
                            }

                            <!-- Labels do eixo Y -->
                            @for (int i = 0; i <= 4; i++)
                            {
                                var valor = (maxValorGrafico / 4) * i;
                                var yPos = 280 - (i * 60);
                                <g>
                                    <text x="45" y="@yPos" text-anchor="end" font-size="10" fill="#666">@valor.ToString("C0", new CultureInfo("pt-BR"))</text>
                                </g>
                                <line x1="48" y1="@yPos" x2="52" y2="@yPos" stroke="#ccc" stroke-width="1"/>
                            }
                        </svg>
                    </div>
                }
                else
                {
                    <p class="text-muted text-center py-4">Nenhum dado dispon√≠vel para a categoria selecionada.</p>
                }
            </div>
        </div>

        <!-- Evolu√ß√£o Mensal -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">üìä Evolu√ß√£o Mensal de Gastos (Geral)</h5>
            </div>
            <div class="card-body">
                @if (evolucaoMensal.Any())
                {
                    <div style="overflow-x: auto;">
                        @foreach (var mes in evolucaoMensal.OrderBy(x => x.Mes))
                        {
                            var altura = totalDespesas > 0 ? (mes.Total / totalDespesas * 300) : 0;
                            <div class="d-inline-block text-center me-3" style="width: 80px;">
                                <div class="bg-primary rounded" 
                                     style="height: @altura.ToString("F0")px; min-height: 20px; vertical-align: bottom;"
                                     title="@mes.Total.ToString("C", new CultureInfo("pt-BR"))">
                                </div>
                                <small class="d-block mt-2"><strong>@mes.Total.ToString("C0", new CultureInfo("pt-BR"))</strong></small>
                                <small class="text-muted">@mes.MesNome</small>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">Nenhuma despesa para mostrar evolu√ß√£o.</p>
                }
            </div>
        </div>

        <!-- Alertas de Or√ßamento -->
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">‚ö†Ô∏è Alertas de Or√ßamento</h5>
            </div>
            <div class="card-body">
                @if (alertasOrcamento.Any())
                {
                    @foreach (var alerta in alertasOrcamento)
                    {
                        <div class="alert alert-danger d-flex justify-content-between align-items-center">
                            <div>
                                <strong>@alerta.CategoriaNome</strong>
                                <p class="mb-0 small">
                                    Gasto: @alerta.TotalGasto.ToString("C", new CultureInfo("pt-BR")) | 
                                    Or√ßamento: @alerta.OrcamentoMensal.ToString("C", new CultureInfo("pt-BR")) | 
                                    <span class="text-danger">Excedido em @alerta.PercentualExcedido.ToString("F1")%</span>
                                </p>
                            </div>
                            <span class="badge bg-danger" style="font-size: 1.2rem;">
                                @((alerta.TotalGasto / alerta.OrcamentoMensal * 100).ToString("F0"))%
                            </span>
                        </div>
                    }
                }
                else
                {
                    <div class="alert alert-success">
                        <span class="oi oi-check me-2"></span>
                        Nenhum or√ßamento excedido no per√≠odo! üéâ
                    </div>
                }
            </div>
        </div>

        <!-- Despesas Detalhadas por Categoria -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">üìã Detalhamento por Categoria</h5>
            </div>
            <div class="card-body">
                @foreach (var cat in despesasPorCategoria.OrderByDescending(x => x.Total))
                {
                    <div class="mb-4">
                        <h6 class="border-bottom pb-2">
                            @cat.CategoriaNome - @cat.Total.ToString("C", new CultureInfo("pt-BR"))
                            <span class="badge bg-secondary ms-2">@cat.Quantidade despesas</span>
                        </h6>
                        @{
                            var despesasCategoria = todasDespesas.Where(d => d.Categoria?.Nome == cat.CategoriaNome).ToList();
                        }
                        @if (despesasCategoria.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Descri√ß√£o</th>
                                            <th>UBS</th>
                                            <th class="text-end">Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var desp in despesasCategoria.OrderByDescending(d => d.CreatedAt))
                                        {
                                            <tr>
                                                <td>@desp.CreatedAt.ToString("dd/MM/yy")</td>
                                                <td>@desp.Descricao</td>
                                                <td>@desp.Esf?.Nome</td>
                                                <td class="text-end">@desp.Valor.ToString("C", new CultureInfo("pt-BR"))</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Comparativo UBS vs Sal√°rios -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üè• Comparativo UBS - Despesas vs Sal√°rios</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>UBS</th>
                                <th class="text-end">Despesas</th>
                                <th class="text-end">Sal√°rios</th>
                                <th class="text-end">Total Geral</th>
                                <th class="text-end">Funcion√°rios</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var ubs in esfList)
                            {
                                var despUbs = despesasPorUBS.FirstOrDefault(d => d.UbsNome == ubs.Nome);
                                var salUbs = salariosPorUBS.FirstOrDefault(s => s.UbsNome == ubs.Nome);
                                var totalDesp = despUbs?.Total ?? 0;
                                var totalSal = salUbs?.TotalSalarios ?? 0;
                                var totalGeral = totalDesp + totalSal;

                                <tr>
                                    <td><strong>@ubs.Nome</strong></td>
                                    <td class="text-end">@totalDesp.ToString("C", new CultureInfo("pt-BR"))</td>
                                    <td class="text-end">@totalSal.ToString("C", new CultureInfo("pt-BR"))</td>
                                    <td class="text-end"><strong>@totalGeral.ToString("C", new CultureInfo("pt-BR"))</strong></td>
                                    <td class="text-end">@(salUbs?.QuantidadeFuncionarios ?? 0)</td>
                                </tr>
                            }
                            <tr class="table-dark">
                                <td><strong>TOTAL GERAL</strong></td>
                                <td class="text-end"><strong>@totalDespesas.ToString("C", new CultureInfo("pt-BR"))</strong></td>
                                <td class="text-end"><strong>@totalSalarios.ToString("C", new CultureInfo("pt-BR"))</strong></td>
                                <td class="text-end"><strong>@((totalDespesas + totalSalarios).ToString("C", new CultureInfo("pt-BR")))</strong></td>
                                <td class="text-end"><strong>@quantidadeFuncionarios</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<Despesa> todasDespesas = new();
    private List<ESF> esfList = new();
    private List<Categoria> categorias = new();
    private List<Funcionario> todosFuncionarios = new();

    private bool carregando = true;
    private string periodoSelecionado = "mes";
    private DateTime dataInicio = DateTime.UtcNow.AddMonths(-1);
    private DateTime dataFim = DateTime.UtcNow;
    private string EsfIdFiltro = "";

    // M√©tricas
    private decimal totalDespesas = 0;
    private int quantidadeDespesas = 0;
    private decimal totalSalarios = 0;
    private int quantidadeFuncionarios = 0;

    private List<DespesaPorCategoria> despesasPorCategoria = new();
    private List<DespesaPorUBS> despesasPorUBS = new();
    private List<SalarioPorUBS> salariosPorUBS = new();
    private List<EvolucaoMensal> evolucaoMensal = new();
    private List<EvolucaoMensal> evolucaoMensalPorCategoria = new();
    private List<AlertaOrcamento> alertasOrcamento = new();
    private string categoriaFiltroGrafico = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await CarregarDados();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Erro ao carregar relat√≥rios:", ex.ToString());
            carregando = false;
        }
    }

    private async Task CarregarDados()
    {
        carregando = true;
        try
        {
            // Ajustar datas conforme per√≠odo
            switch (periodoSelecionado)
            {
                case "mes":
                    dataInicio = new DateTime(DateTime.UtcNow.Year, DateTime.UtcNow.Month, 1, 0, 0, 0, DateTimeKind.Utc);
                    dataFim = dataInicio.AddMonths(1).AddDays(-1);
                    break;
                case "trimestre":
                    dataInicio = DateTime.UtcNow.AddMonths(-3);
                    dataFim = DateTime.UtcNow;
                    break;
                case "semestre":
                    dataInicio = DateTime.UtcNow.AddMonths(-6);
                    dataFim = DateTime.UtcNow;
                    break;
                case "ano":
                    dataInicio = new DateTime(DateTime.UtcNow.Year, 1, 1, 0, 0, 0, DateTimeKind.Utc);
                    dataFim = new DateTime(DateTime.UtcNow.Year, 12, 31, 23, 59, 59, DateTimeKind.Utc);
                    break;
            }

            // Carregar dados
            esfList = await ESFService.GetAllESFAsync() ?? new List<ESF>();
            categorias = await CategoriaService.GetAllCategoriasAsync() ?? new List<Categoria>();

            todasDespesas = await DespesaService.GetDespesasByPeriodoAsync(dataInicio, dataFim) ?? new List<Despesa>();
            if (!string.IsNullOrEmpty(EsfIdFiltro))
            {
                todasDespesas = todasDespesas.Where(d => d.EsfId == EsfIdFiltro).ToList();
            }

            todosFuncionarios = await FuncionarioService.GetAllAsync() ?? new List<Funcionario>();
            if (!string.IsNullOrEmpty(EsfIdFiltro))
            {
                todosFuncionarios = todosFuncionarios.Where(f => f.EsfId == EsfIdFiltro).ToList();
            }

            CalcularMetricas();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Erro ao carregar dados:", ex.ToString());
        }
        finally
        {
            carregando = false;
        }
    }

    private void CalcularMetricas()
    {
        // Totais gerais
        totalDespesas = todasDespesas.Sum(d => d.Valor);
        quantidadeDespesas = todasDespesas.Count;

        totalSalarios = todosFuncionarios.Sum(f => f.Salario);
        quantidadeFuncionarios = todosFuncionarios.Count;

        // Despesas por categoria
        despesasPorCategoria = todasDespesas
            .GroupBy(d => d.Categoria?.Nome ?? "Sem Categoria")
            .Select(g => new DespesaPorCategoria
            {
                CategoriaNome = g.Key,
                Total = g.Sum(d => d.Valor),
                Quantidade = g.Count()
            })
            .ToList();

        // Despesas por UBS
        despesasPorUBS = todasDespesas
            .GroupBy(d => d.Esf?.Nome ?? "Sem ESF")
            .Select(g => new DespesaPorUBS
            {
                UbsNome = g.Key,
                Total = g.Sum(d => d.Valor),
                Quantidade = g.Count()
            })
            .ToList();

        // Sal√°rios por UBS
        salariosPorUBS = todosFuncionarios
            .GroupBy(f => f.Esf?.Nome ?? "Sem ESF")
            .Select(g => new SalarioPorUBS
            {
                UbsNome = g.Key,
                TotalSalarios = g.Sum(f => f.Salario),
                QuantidadeFuncionarios = g.Count()
            })
            .ToList();

        // Evolu√ß√£o mensal
        evolucaoMensal = todasDespesas
            .GroupBy(d => new { d.CreatedAt.Year, d.CreatedAt.Month })
            .Select(g => new EvolucaoMensal
            {
                Ano = g.Key.Year,
                Mes = g.Key.Month,
                MesNome = new DateTime(g.Key.Year, g.Key.Month, 1).ToString("MMM/yy", new CultureInfo("pt-BR")),
                Total = g.Sum(d => d.Valor),
                Quantidade = g.Count()
            })
            .OrderBy(e => e.Ano).ThenBy(e => e.Mes)
            .ToList();

        // Evolu√ß√£o mensal inicial (todas categorias)
        evolucaoMensalPorCategoria = evolucaoMensal;

        // Alertas de or√ßamento ultrapassado
        alertasOrcamento = despesasPorCategoria
            .Select(d => {
                var categoria = categorias.FirstOrDefault(c => c.Nome == d.CategoriaNome);
                if (categoria == null || categoria.OrcamentoMensal == 0) return null;

                var percentual = (d.Total / categoria.OrcamentoMensal) * 100;
                if (percentual <= 100) return null;

                return new AlertaOrcamento
                {
                    CategoriaNome = d.CategoriaNome,
                    OrcamentoMensal = categoria.OrcamentoMensal ?? 0,
                    TotalGasto = d.Total,
                    PercentualExcedido = (decimal)(percentual - 100)
                };
            })
            .Where(a => a != null)
            .Cast<AlertaOrcamento>()
            .OrderByDescending(a => a.PercentualExcedido)
            .ToList();
    }

    private void AtualizarGraficoLinha()
    {
        if (string.IsNullOrEmpty(categoriaFiltroGrafico))
        {
            // Todas as categorias
            evolucaoMensalPorCategoria = evolucaoMensal;
        }
        else if (categoriaFiltroGrafico == "SALARIOS")
        {
            // Mostrar evolu√ß√£o de sal√°rios por m√™s
            evolucaoMensalPorCategoria = todosFuncionarios
                .GroupBy(f => new { f.CreatedAt.Year, f.CreatedAt.Month })
                .Select(g => new EvolucaoMensal
                {
                    Ano = g.Key.Year,
                    Mes = g.Key.Month,
                    MesNome = new DateTime(g.Key.Year, g.Key.Month, 1).ToString("MMM/yy", new CultureInfo("pt-BR")),
                    Total = g.Sum(f => f.Salario),
                    Quantidade = g.Count()
                })
                .OrderBy(e => e.Ano).ThenBy(e => e.Mes)
                .ToList();
        }
        else
        {
            // Categoria espec√≠fica de despesa
            evolucaoMensalPorCategoria = todasDespesas
                .Where(d => d.CategoriaId == categoriaFiltroGrafico)
                .GroupBy(d => new { d.CreatedAt.Year, d.CreatedAt.Month })
                .Select(g => new EvolucaoMensal
                {
                    Ano = g.Key.Year,
                    Mes = g.Key.Month,
                    MesNome = new DateTime(g.Key.Year, g.Key.Month, 1).ToString("MMM/yy", new CultureInfo("pt-BR")),
                    Total = g.Sum(d => d.Valor),
                    Quantidade = g.Count()
                })
                .OrderBy(e => e.Ano).ThenBy(e => e.Mes)
                .ToList();
        }
    }

    private string GetCategoriaColor(string categoria) => categoria switch
    {
        "Medicamentos" => "bg-danger",
        "Material M√©dico" => "bg-primary",
        "Contas Fixas" => "bg-warning",
        "Pessoal" => "bg-success",
        "Infraestrutura" => "bg-secondary",
        "Servi√ßos" => "bg-info",
        _ => "bg-dark"
    };

    private async Task ExportarExcel()
    {
        await JSRuntime.InvokeVoidAsync("alert", "Exporta√ß√£o Excel em desenvolvimento");
    }

    private async Task ExportarPDF()
    {
        await JSRuntime.InvokeVoidAsync("alert", "Exporta√ß√£o PDF em desenvolvimento");
    }

    // DTOs
    public class DespesaPorCategoria
    {
        public string CategoriaNome { get; set; } = "";
        public decimal Total { get; set; }
        public int Quantidade { get; set; }
    }

    public class DespesaPorUBS
    {
        public string UbsNome { get; set; } = "";
        public decimal Total { get; set; }
        public int Quantidade { get; set; }
    }

    public class SalarioPorUBS
    {
        public string UbsNome { get; set; } = "";
        public decimal TotalSalarios { get; set; }
        public int QuantidadeFuncionarios { get; set; }
    }

    public class EvolucaoMensal
    {
        public int Ano { get; set; }
        public int Mes { get; set; }
        public string MesNome { get; set; } = "";
        public decimal Total { get; set; }
        public int Quantidade { get; set; }
    }

    public class AlertaOrcamento
    {
        public string CategoriaNome { get; set; } = "";
        public decimal OrcamentoMensal { get; set; }
        public decimal TotalGasto { get; set; }
        public decimal PercentualExcedido { get; set; }
    }
}

