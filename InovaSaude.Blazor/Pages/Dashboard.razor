@page "/dashboard"
@using InovaSaude.Blazor.Services
@inject DashboardService DashboardService
@inject ToastService ToastService
@inject NavigationManager Navigation
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<PageTitle>Dashboard - InovaSaÃºde</PageTitle>

<LoadingOverlay IsLoading="carregando" Message="Carregando dashboard..." />

<SkeletonLoader IsLoading="carregando" Type="SkeletonLoader.SkeletonType.Card">
    <div class="container-fluid mt-4">
   <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ğŸ“Š Dashboard Financeiro</h2>
      <div>
    <span class="text-muted">Ãšltima atualizaÃ§Ã£o: @DateTime.Now.ToString("dd/MM/yyyy HH:mm")</span>
  </div>
        </div>

        <!-- Cards de Resumo -->
  <div class="row g-3 mb-4">
   <!-- Total Geral -->
     <div class="col-md-4">
         <div class="card border-0 shadow-sm h-100 card-hover">
     <div class="card-body">
<div class="d-flex justify-content-between align-items-start">
<div>
     <h6 class="text-muted mb-2">ğŸ’° Total Geral</h6>
       <h3 class="mb-0 fw-bold">@FormatarMoeda(dados?.TotalGeral ?? 0)</h3>
    <small class="text-success">@((dados?.TotalDespesas ?? 0)) despesas</small>
     </div>
    <div class="icon-circle bg-primary-subtle">
       <span class="fs-3">ğŸ’µ</span>
</div>
     </div>
     </div>
    </div>
   </div>

 <!-- MÃ©dia por Despesa -->
   <div class="col-md-4">
    <div class="card border-0 shadow-sm h-100 card-hover">
   <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
  <div>
        <h6 class="text-muted mb-2">ğŸ“Š MÃ©dia por Despesa</h6>
    <h3 class="mb-0 fw-bold text-info">@FormatarMoeda((dados?.TotalDespesas ?? 0) > 0 ? (dados?.TotalGeral ?? 0) / (dados?.TotalDespesas ?? 1) : 0)</h3>
            <small class="text-muted">valor mÃ©dio</small>
  </div>
     <div class="icon-circle bg-info-subtle">
      <span class="fs-3">ğŸ“ˆ</span>
</div>
            </div>
        </div>
  </div>
        </div>

        <!-- Total de Categorias -->
<div class="col-md-4">
         <div class="card border-0 shadow-sm h-100 card-hover">
    <div class="card-body">
   <div class="d-flex justify-content-between align-items-start">
   <div>
          <h6 class="text-muted mb-2">ğŸ“ Categorias</h6>
      <h3 class="mb-0 fw-bold text-warning">@((dados?.DespesasPorCategoria?.Count ?? 0))</h3>
     <small class="text-muted">categorias ativas</small>
   </div>
         <div class="icon-circle bg-warning-subtle">
        <span class="fs-3">ğŸ—‚ï¸</span>
      </div>
 </div>
      </div>
        </div>
        </div>
        </div>

        <!-- GrÃ¡ficos visuais CSS -->
        <div class="row g-3 mb-4">
  <div class="col-md-12">
        <div class="card border-0 shadow-sm h-100">
 <div class="card-header bg-white">
    <h5 class="mb-0">ğŸ“ˆ Top 10 Categorias</h5>
    </div>
<div class="card-body">
     @if (dados?.DespesasPorCategoria != null && dados.DespesasPorCategoria.Any())
      {
       var maxValue = dados.DespesasPorCategoria.Max(c => c.Total);
    @foreach (var item in dados.DespesasPorCategoria.Take(10))
   {
   var percentage = maxValue > 0 ? (item.Total / maxValue * 100) : 0;
   <div class="mb-3">
       <div class="d-flex justify-content-between mb-1">
     <span class="fw-semibold">@item.Categoria</span>
       <span class="text-muted">@FormatarMoeda(item.Total)</span>
   </div>
      <div class="progress" style="height: 25px;">
   <div class="progress-bar bg-primary" 
   style="width: @percentage%">
   <span class="px-2">@item.Quantidade despesas</span>
      </div>
  </div>
    </div>
  }
   }
       else
      {
    <p class="text-muted text-center py-4">Nenhum dado disponÃ­vel</p>
 }
  </div>
     </div>
   </div>
        </div>

        <!-- AÃ§Ãµes RÃ¡pidas -->
 <div class="row g-3">
   <div class="col-md-12">
        <div class="card border-0 shadow-sm">
    <div class="card-header bg-white">
   <h5 class="mb-0">âš¡ AÃ§Ãµes RÃ¡pidas</h5>
    </div>
        <div class="card-body">
    <div class="row g-3 text-center">
      <div class="col-md-3">
    <a href="/gerenciar-despesas" class="btn btn-outline-primary btn-lg w-100 p-4">
 <div class="fs-1 mb-2">ğŸ’°</div>
         <div>Gerenciar Despesas</div>
         </a>
      </div>
     <div class="col-md-3">
      <a href="/relatorios" class="btn btn-outline-success btn-lg w-100 p-4">
   <div class="fs-1 mb-2">ğŸ“Š</div>
           <div>RelatÃ³rios</div>
        </a>
  </div>
     <div class="col-md-3">
      <a href="/gerenciar-usuarios" class="btn btn-outline-info btn-lg w-100 p-4">
   <div class="fs-1 mb-2">ğŸ‘¥</div>
    <div>Gerenciar UsuÃ¡rios</div>
   </a>
        </div>
   <div class="col-md-3">
     <a href="/integracoes-externas" class="btn btn-outline-warning btn-lg w-100 p-4">
        <div class="fs-1 mb-2">ğŸ”Œ</div>
      <div>IntegraÃ§Ãµes</div>
     </a>
 </div>
     </div>
  </div>
   </div>
 </div>
  </div>
    </div>
</SkeletonLoader>

<style>
    .card-hover {
   transition: transform 0.2s, box-shadow 0.2s;
    }

    .card-hover:hover {
 transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }

    .icon-circle {
     width: 60px;
   height: 60px;
        border-radius: 50%;
   display: flex;
 align-items: center;
        justify-content: center;
    }

    .progress-bar {
 transition: width 0.6s ease;
 }
</style>

@code {
    private InovaSaude.Blazor.Services.DashboardData? dados;
 private bool carregando = true;

    protected override async Task OnInitializedAsync()
  {
  await CarregarDados();
    }

    private async Task CarregarDados()
 {
carregando = true;
  try
   {
   dados = await DashboardService.GetDashboardDataAsync();
 }
  catch (Exception ex)
     {
      ToastService.ShowError($"Erro ao carregar dashboard: {ex.Message}");
   }
 finally
      {
  carregando = false;
  }
    }

 private string FormatarMoeda(decimal valor)
  {
  return valor.ToString("C2", new System.Globalization.CultureInfo("pt-BR"));
    }
}
