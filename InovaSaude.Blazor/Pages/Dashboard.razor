@page "/dashboard"
@inject InovaSaude.Blazor.Services.DashboardService DashboardService
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<PageTitle>Dashboard - InovaSa√∫de</PageTitle>

<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
     <div>
<h2>üìä Dashboard Gerencial</h2>
   <p class="text-muted mb-0">Vis√£o geral do sistema em tempo real</p>
        </div>
   <div>
    <button class="btn btn-outline-primary" @onclick="AtualizarDados">
     <span class="oi oi-reload me-2"></span>Atualizar
    </button>
   </div>
    </div>

    @if (stats == null)
    {
        <div class="text-center py-5">
<div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
     <p class="mt-3">Carregando dashboard...</p>
 </div>
    }
    else
    {
  <!-- Cards Principais -->
 <div class="row mb-4">
      <!-- Total UBS -->
  <div class="col-md-3 mb-3">
  <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
      <div class="d-flex justify-content-between align-items-start">
    <div>
     <p class="text-muted mb-1 small">Total de UBS</p>
      <h3 class="mb-0 fw-bold">@stats.TotalUBS</h3>
    <small class="text-success">
   <span class="oi oi-arrow-top me-1"></span>Ativas
 </small>
      </div>
       <div class="bg-primary bg-opacity-10 rounded p-3">
     <span class="text-primary" style="font-size: 2rem;">üè•</span>
      </div>
       </div>
       </div>
        </div>
   </div>

        <!-- Despesas do M√™s -->
            <div class="col-md-3 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
 <div>
         <p class="text-muted mb-1 small">Despesas do M√™s</p>
       <h3 class="mb-0 fw-bold">@stats.TotalDespesasMes.ToString("C0")</h3>
       <small class="text-info">
   <span class="oi oi-calendar me-1"></span>@DateTime.Now.ToString("MMM/yyyy")
  </small>
     </div>
  <div class="bg-success bg-opacity-10 rounded p-3">
      <span class="text-success" style="font-size: 2rem;">üí∞</span>
    </div>
 </div>
     </div>
   </div>
      </div>

   <!-- Despesas Pendentes -->
     <div class="col-md-3 mb-3">
       <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
      <div class="d-flex justify-content-between align-items-start">
       <div>
       <p class="text-muted mb-1 small">Pendentes</p>
    <h3 class="mb-0 fw-bold">@stats.DespesasPendentes</h3>
    <small class="text-warning">
 <span class="oi oi-clock me-1"></span>Aguardando
       </small>
  </div>
 <div class="bg-warning bg-opacity-10 rounded p-3">
        <span class="text-warning" style="font-size: 2rem;">‚è≥</span>
      </div>
    </div>
</div>
   </div>
     </div>

       <!-- Usu√°rios Ativos -->
       <div class="col-md-3 mb-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
   <div class="d-flex justify-content-between align-items-start">
    <div>
     <p class="text-muted mb-1 small">Usu√°rios Ativos</p>
    <h3 class="mb-0 fw-bold">@stats.TotalUsuarios</h3>
   <small class="text-primary">
    <span class="oi oi-people me-1"></span>No sistema
     </small>
     </div>
     <div class="bg-info bg-opacity-10 rounded p-3">
         <span class="text-info" style="font-size: 2rem;">üë•</span>
    </div>
 </div>
         </div>
          </div>
 </div>
      </div>

        <!-- Gr√°fico de Despesas por Categoria -->
      <div class="row mb-4">
   <div class="col-lg-8 mb-3">
      <div class="card border-0 shadow-sm">
       <div class="card-header bg-white">
     <h5 class="mb-0">üìä Despesas por Categoria (√öltimos 6 Meses)</h5>
    </div>
      <div class="card-body">
            @if (stats.DespesasPorCategoria.Any())
  {
    var maxValor = stats.DespesasPorCategoria.Max(c => c.Valor);
          foreach (var categoria in stats.DespesasPorCategoria.OrderByDescending(c => c.Valor).Take(8))
     {
  var percentual = maxValor > 0 ? (double)(categoria.Valor / maxValor) * 100 : 0;
    <div class="mb-3">
       <div class="d-flex justify-content-between mb-1">
      <span class="fw-semibold">@categoria.Nome</span>
    <span class="text-muted">@categoria.Valor.ToString("C0") (@categoria.Quantidade itens)</span>
   </div>
     <div class="progress" style="height: 25px;">
      <div class="progress-bar @GetCategoriaColor(categoria.Nome)" 
    role="progressbar" 
      style="width: @percentual%"
         aria-valuenow="@percentual" 
      aria-valuemin="0" 
    aria-valuemax="100">
      @percentual.ToString("F0")%
        </div>
      </div>
      </div>
  }
      }
      else
         {
 <p class="text-muted text-center py-4">Nenhum dado dispon√≠vel</p>
      }
       </div>
          </div>
        </div>

        <!-- Top 5 UBS por Gastos -->
      <div class="col-lg-4 mb-3">
   <div class="card border-0 shadow-sm">
     <div class="card-header bg-white">
   <h5 class="mb-0">üè• Top 5 UBS</h5>
     </div>
 <div class="card-body">
    @if (stats.DespesasPorUBS.Any())
    {
        <div class="list-group list-group-flush">
      @foreach (var (ubs, index) in stats.DespesasPorUBS.OrderByDescending(u => u.Valor).Take(5).Select((u, i) => (u, i + 1)))
    {
       <div class="list-group-item border-0 px-0">
   <div class="d-flex justify-content-between align-items-center">
 <div>
        <span class="badge @GetPositionBadge(index) me-2">@index¬∞</span>
    <strong>@ubs.Nome</strong>
   </div>
   </div>
 <div class="mt-2">
      <div class="d-flex justify-content-between small text-muted">
   <span>@ubs.Quantidade despesas</span>
     <strong class="text-dark">@ubs.Valor.ToString("C0")</strong>
      </div>
     </div>
 </div>
        }
    </div>
      }
    else
        {
<p class="text-muted text-center py-4">Nenhum dado dispon√≠vel</p>
    }
    </div>
   </div>
        </div>
    </div>

      <!-- Atividades Recentes -->
 <div class="row">
         <div class="col-12">
        <div class="card border-0 shadow-sm">
   <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">üìã Atividades Recentes</h5>
    <span class="badge bg-primary">√öltimas 10</span>
 </div>
   <div class="card-body p-0">
     @if (stats.UltimasAtividades.Any())
     {
      <div class="table-responsive">
        <table class="table table-hover mb-0">
 <thead class="table-light">
        <tr>
    <th>A√ß√£o</th>
      <th>Usu√°rio</th>
          <th>Data/Hora</th>
         </tr>
      </thead>
    <tbody>
 @foreach (var atividade in stats.UltimasAtividades)
     {
        <tr>
    <td>
        <span class="text-primary">‚óè</span>
 @atividade.Descricao
      </td>
     <td>@atividade.Usuario</td>
        <td class="text-muted">@atividade.DataHora.ToString("dd/MM/yyyy HH:mm")</td>
     </tr>
  }
    </tbody>
     </table>
</div>
    }
        else
     {
        <p class="text-muted text-center py-4">Nenhuma atividade recente</p>
        }
   </div>
    </div>
         </div>
     </div>
    }
</div>

@code {
    private InovaSaude.Blazor.Services.DashboardStats? stats;

    protected override async Task OnInitializedAsync()
    {
 await CarregarDados();
}

    private async Task CarregarDados()
    {
     stats = await DashboardService.GetDashboardStatsAsync();
    }

  private async Task AtualizarDados()
    {
        await CarregarDados();
StateHasChanged();
}

    private string GetCategoriaColor(string categoria)
    {
   return categoria.ToLower() switch
  {
            var c when c.Contains("medicamento") => "bg-danger",
        var c when c.Contains("material") => "bg-primary",
   var c when c.Contains("pessoal") => "bg-success",
      var c when c.Contains("infraestrutura") => "bg-warning",
        _ => "bg-info"
     };
    }

    private string GetPositionBadge(int position)
    {
    return position switch
        {
   1 => "bg-warning text-dark",
   2 => "bg-secondary",
     3 => "bg-info",
      _ => "bg-light text-dark"
   };
    }
}
