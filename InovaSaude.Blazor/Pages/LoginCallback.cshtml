@page "/login-callback"
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using System.Security.Claims
@using InovaSaude.Blazor.Services
@inject UsuarioService UsuarioService

@{
 var email = Request.Query["email"].ToString();
    
    if (!string.IsNullOrEmpty(email))
    {
  var user = await UsuarioService.GetUsuarioByEmailAsync(email);
        
 if (user != null && user.Status == "ATIVO")
        {
            var claims = new List<Claim>
            {
       new Claim(ClaimTypes.NameIdentifier, user.Id),
        new Claim(ClaimTypes.Name, user.Nome),
     new Claim(ClaimTypes.Email, user.Email),
 new Claim(ClaimTypes.Role, user.Perfil.ToString()),
     new Claim("perfil", user.Perfil.ToString())
            };

            if (!string.IsNullOrEmpty(user.UbsId))
         {
   claims.Add(new Claim("ubsId", user.UbsId));
            }

            var identity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
    var principal = new ClaimsPrincipal(identity);

            var authProperties = new AuthenticationProperties
            {
         IsPersistent = true,
   ExpiresUtc = DateTimeOffset.UtcNow.AddHours(8),
           AllowRefresh = true
      };

    await HttpContext.SignInAsync(
    CookieAuthenticationDefaults.AuthenticationScheme,
                principal,
         authProperties
            );

        Response.Redirect("/dashboard");
        return;
      }
    }
    
    Response.Redirect("/login?error=true");
}
